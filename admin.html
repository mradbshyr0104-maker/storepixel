<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…ØªØ¬Ø± Ø¨ÙƒØ³Ù„</title>
    <link rel="icon" href="https://i.postimg.cc/cH21G5hv/017ce4679e425014.gif" type="image/gif">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="supabase-api.js"></script>
    <script src="supabase-admin.js"></script>
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;700;900&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0A0A0A;
            color: #E5E7EB;
        }
        .btn-primary {
            background-color: #06b6d4; /* bg-cyan-500 */
            color: #111827; /* text-gray-900 */
            font-weight: 700;
            padding: 0.75rem 2rem; /* py-3 px-8 */
            border-radius: 9999px; /* rounded-full */
            transition: all 300ms;
            transform: scale(1);
            box-shadow: 0 10px 15px -3px rgba(6, 182, 212, 0.5), 0 4px 6px -2px rgba(6, 182, 212, 0.5); /* shadow-xl shadow-cyan-500/50 */
        }
        .btn-primary:hover {
            background-color: #22d3ee; /* hover:bg-cyan-400 */
            transform: scale(1.05);
        }
        .input-field {
            background-color: #111827; /* bg-gray-900 */
            color: #ffffff; /* text-white */
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.25rem; /* rounded */
            padding: 0.5rem; /* p-2 */
            transition: all 150ms;
        }
        .input-field:focus {
            --tw-ring-color: #06b6d4; /* focus:ring-cyan-500 */
            border-color: #06b6d4; /* focus:border-cyan-500 */
        }
        .input-field::placeholder {
            color: #6b7280; /* placeholder:text-gray-500 */
        }
        /* ÙƒÙˆØ¯ ØµØ±ÙŠØ­ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
        .input-field option {
            background-color: white;
            color: #000000; /* Ù„ÙˆÙ† Ø£Ø³ÙˆØ¯ ØµØ±ÙŠØ­ */
        }
        .input-field optgroup {
            background-color: white;
            color: #0891b2; /* Ù„ÙˆÙ† Ø³ÙŠØ§Ù† Ø¯Ø§ÙƒÙ† */
            font-weight: bold;
        }
        /* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Toast) */
        @keyframes fade-in-right {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fade-out-right {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        .toast-fade-in {
            animation: fade-in-right 0.5s ease-out forwards;
        }
        .toast-fade-out {
            animation: fade-out-right 0.5s ease-in forwards;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Toast) -->
    <div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-3 w-full max-w-xs">
        <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
    </div>

    <main id="admin-content" class="min-h-screen">
        <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§ -->
    </main>

    <!-- Ù†Ø§ÙØ°Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© -->
    <div id="image-preview-modal" class="fixed inset-0 bg-black bg-opacity-75 z-[200] hidden flex items-center justify-center p-4" onclick="closeImagePreview()">
        <div class="relative max-w-4xl max-h-full">
            <img id="preview-image" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
            <button onclick="closeImagePreview()" class="absolute top-2 right-2 bg-red-600 hover:bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center">
                Ã—
            </button>
            <p id="preview-title" class="absolute bottom-2 left-2 bg-black bg-opacity-75 text-white px-3 py-1 rounded"></p>
        </div>
    </div>

    <!-- Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3" preload="auto"></audio>
        <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§ -->
    </main>
    <div id="logout-button-container" class="fixed bottom-4 left-4 z-50">
        <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù‡Ù†Ø§ -->
    </div>

    <script>
        // === Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase ===
        let allProducts = {};
        let currentUser = null;
        
        // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        const ADMIN_PASSWORD = 'pixel-2025';
        
        // Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
        const initialProductStructure = {
            vehicles: [],
            investments: [],
            sponsors: [],
            moneyServices: [],
            banJail: [],
            orders: [],
            discountCodes: [],
            featuredProducts: {
                isActive: false,
                products: [],
                startDate: null,
                endDate: null
            },
            sale: {
                isActive: false,
                percentage: 0,
                text: 'ğŸ‰ Ø¹Ø±Ø¶ Ø®Ø§Øµ! Ø®ØµÙ… {percentage}% Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª!',
                color: '#f59e0b'
            },
            maintenanceMode: {
                isActive: false,
                message: 'Ù†Ø­Ù† Ù†Ù‚ÙˆÙ… Ø¨Ø¨Ø¹Ø¶ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. Ø³Ù†Ø¹ÙˆØ¯ Ù‚Ø±ÙŠØ¨Ø§Ù‹!'
            }
        };
        


        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase
        async function getAllData() {
            try {
                allProducts = await supabaseAdmin.getAllData();
                return allProducts;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                return allProducts;
            }
        }



        // === Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Toast) ===
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toastId = `toast-${Date.now()}`;
            const colors = {
                success: 'bg-green-500 border-green-600',
                error: 'bg-red-500 border-red-600',
                info: 'bg-cyan-500 border-cyan-600'
            };

            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `p-4 text-white rounded-lg shadow-2xl border-l-4 ${colors[type]} toast-fade-in flex justify-between items-center`;
            toast.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="text-white/70 hover:text-white">&times;</button>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 5000); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
        }

        // === Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===

        async function getUsers() {
            const data = await getAllData();
            return data.users || [];
        }

        async function addUser(username, password, role, permissions) {
            try {
                const newUser = { 
                    username, 
                    password, 
                    role, 
                    permissions: permissions || { orders: true, products_view: true, products_edit: false, sales: false, discounts: true, receipt: true, users: false, settings: false },
                    created_at: new Date().toISOString() 
                };
                await supabaseAdmin.addUser(newUser);
                return true;
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…:', e);
                return false;
            }
        }

        async function updateUserPermissions(userId, permissions) {
            try {
                await supabaseAdmin.updateUser(userId, { permissions });
                return true;
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', e);
                return false;
            }
        }

        function hasPermission(section) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin' && currentUser.username === 'admin') return true;
            if (currentUser.role === 'admin') return currentUser.permissions?.[section] !== false;
            return currentUser.permissions?.[section] === true;
        }

        async function deleteUser(userId) {
            try {
                await supabaseAdmin.deleteUser(userId);
                return true;
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…:', e);
                return false;
            }
        }

        function renderLoginPage(error = '') {
            const mainContent = document.getElementById('admin-content');
            mainContent.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-900">
                    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl border border-cyan-500/50 w-full max-w-md text-center">
                        <img src="https://i.postimg.cc/cH21G5hv/017ce4679e425014.gif" alt="Ø´Ø¹Ø§Ø±" class="h-24 w-auto mx-auto mb-4">
                        <h2 class="text-3xl font-bold text-white mb-6">Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                        <form id="login-form">
                            <div class="mb-4 text-right">
                                <label for="username" class="block text-lg font-medium text-cyan-400 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                                <input type="text" id="username" name="username" required class="input-field w-full text-center text-lg p-3">
                            </div>
                            <div class="mb-4 text-right">
                                <label for="password" class="block text-lg font-medium text-cyan-400 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <input type="password" id="password" name="password" required class="input-field w-full text-center text-lg p-3 tracking-widest">
                            </div>
                            ${error ? `<p class="text-red-400 mb-4">${error}</p>` : ''}
                            <button type="submit" class="w-full btn-primary">Ø¯Ø®ÙˆÙ„</button>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-button-container').innerHTML = '';
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            if (username === 'admin' && password === ADMIN_PASSWORD) {
                currentUser = { 
                    username: 'admin', 
                    role: 'admin',
                    permissions: { orders: true, products_view: true, products_edit: true, sales: true, discounts: true, receipt: true, users: true, settings: true }
                };
                sessionStorage.setItem('isAdminAuthenticated', 'true');
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                await initializeAdminPanel();
                return;
            }
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†
            const users = await getUsers();
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = { username: user.username, role: user.role, permissions: user.permissions };
                sessionStorage.setItem('isAdminAuthenticated', 'true');
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                await initializeAdminPanel();
            } else {
                renderLoginPage('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
            }
        }

        function handleLogout() {
            currentUser = null;
            sessionStorage.removeItem('isAdminAuthenticated');
            sessionStorage.removeItem('currentUser');
            renderLoginPage();
        }

        function renderLogoutButton() {
            const userInfo = currentUser ? `<span class="text-cyan-400 ml-2">${currentUser.username} (${currentUser.role === 'admin' ? 'Ø£Ø¯Ù…Ù†' : 'Ù…Ø³Ø¤ÙˆÙ„'})</span>` : '';
            document.getElementById('logout-button-container').innerHTML = `
                <div class="flex items-center gap-2">
                    ${userInfo}
                    <button onclick="handleLogout()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition transform hover:scale-105">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>`;
        }

        function showUsersManagement() {
            getUsers().then(users => {
            const usersHtml = `
                <div class="bg-gray-900 p-6 rounded-xl shadow-lg border border-blue-500 mb-8">
                    <h3 class="text-3xl font-bold text-blue-400 mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h4 class="text-xl font-semibold text-white mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h4>
                            <form onsubmit="handleAddUser(event)" class="space-y-3">
                                <div><label class="text-sm text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input name="username" type="text" required class="input-field w-full"></div>
                                <div><label class="text-sm text-gray-400">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input name="password" type="password" required class="input-field w-full"></div>
                                <div>
                                    <label class="text-sm text-gray-400">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                                    <select name="role" required class="input-field w-full" style="color: #000000; background-color: #FFFFFF;">
                                        <option value="supervisor">Ù…Ø³Ø¤ÙˆÙ„</option>
                                        <option value="admin">Ø£Ø¯Ù…Ù†</option>
                                    </select>
                                </div>
                                <div class="border-t border-gray-700 pt-3 mt-3">
                                    <label class="text-sm text-gray-400 mb-2 block">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 text-white cursor-pointer">
                                            <input type="checkbox" name="perm_orders" checked class="w-4 h-4">
                                            <span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-white cursor-pointer">
                                            <input type="checkbox" name="perm_products_view" checked class="w-4 h-4">
                                            <span>Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-white cursor-pointer">
                                            <input type="checkbox" name="perm_products_edit" class="w-4 h-4">
                                            <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-white cursor-pointer">
                                            <input type="checkbox" name="perm_sales" class="w-4 h-4">
                                            <span>Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-white cursor-pointer">
                                            <input type="checkbox" name="perm_discounts" checked class="w-4 h-4">
                                            <span>Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ…</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-white cursor-pointer">
                                            <input type="checkbox" name="perm_receipt" checked class="w-4 h-4">
                                            <span>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙŠØµØ§Ù„</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-white cursor-pointer">
                                            <input type="checkbox" name="perm_settings" class="w-4 h-4">
                                            <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                                        </label>
                                    </div>
                                </div>
                                <button type="submit" class="w-full btn-primary py-2">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
                            </form>
                        </div>
                        <div class="lg:col-span-2 space-y-3 max-h-96 overflow-y-auto">
                            <h4 class="text-xl font-semibold text-white mb-4">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†</h4>
                            ${users.length > 0 ? users.map(u => `
                                <div class="bg-gray-800 p-3 rounded-lg">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <p class="font-bold text-white">${u.username}</p>
                                            <p class="text-xs text-cyan-400">${u.role === 'admin' ? 'Ø£Ø¯Ù…Ù†' : 'Ù…Ø³Ø¤ÙˆÙ„'}</p>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="showEditPermissions(${u.id})" class="text-blue-400 hover:text-blue-300 p-2 rounded-full bg-gray-900 hover:bg-gray-700 transition" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª">
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path></svg>
                                            </button>
                                            <button onclick="handleDeleteUser(${u.id})" class="text-red-500 hover:text-red-400 p-2 rounded-full bg-gray-900 hover:bg-gray-700 transition" title="Ø­Ø°Ù">
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-400 flex flex-wrap gap-2">
                                        ${u.permissions?.orders ? '<span class="bg-green-900 px-2 py-1 rounded">Ø·Ù„Ø¨Ø§Øª</span>' : ''}
                                        ${u.permissions?.products_view ? '<span class="bg-green-900 px-2 py-1 rounded">Ø±Ø¤ÙŠØ© Ù…Ù†ØªØ¬Ø§Øª</span>' : ''}
                                        ${u.permissions?.products_edit ? '<span class="bg-blue-900 px-2 py-1 rounded">ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª</span>' : ''}
                                        ${u.permissions?.sales ? '<span class="bg-yellow-900 px-2 py-1 rounded">Ù…Ø¨ÙŠØ¹Ø§Øª</span>' : ''}
                                        ${u.permissions?.discounts ? '<span class="bg-green-900 px-2 py-1 rounded">Ø®ØµÙˆÙ…Ø§Øª</span>' : ''}
                                        ${u.permissions?.receipt ? '<span class="bg-green-900 px-2 py-1 rounded">Ø¥ÙŠØµØ§Ù„Ø§Øª</span>' : ''}
                                        ${u.permissions?.settings ? '<span class="bg-green-900 px-2 py-1 rounded">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>' : ''}
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†.</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            const container = document.querySelector('.max-w-7xl');
            if (container) {
                container.insertAdjacentHTML('afterbegin', usersHtml);
            }
            }).catch(err => console.error('Error loading users:', err));
        }

        function showEditPermissions(userId) {
            getUsers().then(users => {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-xl max-w-md w-full mx-4">
                    <h3 class="text-2xl font-bold text-white mb-4">ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª: ${user.username}</h3>
                    <form onsubmit="handleUpdatePermissions(event, ${userId})" class="space-y-3">
                        <label class="flex items-center gap-2 text-white cursor-pointer">
                            <input type="checkbox" name="orders" ${user.permissions?.orders ? 'checked' : ''} class="w-4 h-4">
                            <span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                        </label>
                        <label class="flex items-center gap-2 text-white cursor-pointer">
                            <input type="checkbox" name="products_view" ${user.permissions?.products_view ? 'checked' : ''} class="w-4 h-4">
                            <span>Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                        </label>
                        <label class="flex items-center gap-2 text-white cursor-pointer">
                            <input type="checkbox" name="products_edit" ${user.permissions?.products_edit ? 'checked' : ''} class="w-4 h-4">
                            <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                        </label>
                        <label class="flex items-center gap-2 text-white cursor-pointer">
                            <input type="checkbox" name="sales" ${user.permissions?.sales ? 'checked' : ''} class="w-4 h-4">
                            <span>Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                        </label>
                        <label class="flex items-center gap-2 text-white cursor-pointer">
                            <input type="checkbox" name="discounts" ${user.permissions?.discounts ? 'checked' : ''} class="w-4 h-4">
                            <span>Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ…</span>
                        </label>
                        <label class="flex items-center gap-2 text-white cursor-pointer">
                            <input type="checkbox" name="receipt" ${user.permissions?.receipt ? 'checked' : ''} class="w-4 h-4">
                            <span>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙŠØµØ§Ù„</span>
                        </label>
                        <label class="flex items-center gap-2 text-white cursor-pointer">
                            <input type="checkbox" name="settings" ${user.permissions?.settings ? 'checked' : ''} class="w-4 h-4">
                            <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                        </label>
                        <div class="flex gap-2 mt-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-2 rounded">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded">Ø­ÙØ¸</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            });
        }

        async function handleUpdatePermissions(event, userId) {
            event.preventDefault();
            const form = event.target;
            const permissions = {
                orders: form.orders.checked,
                products_view: form.products_view.checked,
                products_edit: form.products_edit.checked,
                sales: form.sales.checked,
                discounts: form.discounts.checked,
                receipt: form.receipt.checked,
                settings: form.settings.checked,
                users: false
            };
            
            if (await updateUserPermissions(userId, permissions)) {
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª!', 'success');
                form.closest('.fixed').remove();
                renderAdminPage();
            } else {
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª', 'error');
            }
        }

        async function handleAddUser(event) {
            event.preventDefault();
            const form = event.target;
            const username = form.username.value.trim();
            const password = form.password.value;
            const role = form.role.value;
            const permissions = {
                orders: form.perm_orders.checked,
                products_view: form.perm_products_view.checked,
                products_edit: form.perm_products_edit.checked,
                sales: form.perm_sales.checked,
                discounts: form.perm_discounts.checked,
                receipt: form.perm_receipt.checked,
                settings: form.perm_settings.checked,
                users: false
            };
            
            if (await addUser(username, password, role, permissions)) {
                showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                form.reset();
                renderAdminPage();
            } else {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            }
        }

        async function handleDeleteUser(userId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                if (await deleteUser(userId)) {
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    renderAdminPage();
                } else {
                    showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
                }
            }
        }

        // === Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ø¥ÙŠØµØ§Ù„ ===
        function showReceiptVerification() {
            const verificationHtml = `
                <div class="bg-gray-900 p-6 rounded-xl shadow-lg border border-purple-500 mb-8">
                    <h3 class="text-3xl font-bold text-purple-400 mb-6">ğŸ“ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ø¥ÙŠØµØ§Ù„</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h4 class="text-xl font-semibold text-white mb-4">Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¥ÙŠØµØ§Ù„</h4>
                            <form onsubmit="verifyReceipt(event)" class="space-y-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-2 block">ÙƒÙˆØ¯ Ø§Ù„Ø¥ÙŠØµØ§Ù„</label>
                                    <input 
                                        type="text" 
                                        id="receipt-code" 
                                        placeholder="Ù…Ø«Ø§Ù„: ORD-1234567890" 
                                        required 
                                        class="input-field w-full text-center text-2xl font-mono tracking-wider uppercase"
                                    >
                                </div>
                                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-6 rounded-lg transition transform hover:scale-105">
                                    ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙŠØµØ§Ù„
                                </button>
                            </form>
                        </div>
                        <div id="receipt-result" class="bg-gray-800 p-6 rounded-lg">
                            <div class="flex flex-col items-center justify-center h-full text-gray-500">
                                <svg class="w-24 h-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="text-lg">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ù„Ù„ØªØ­Ù‚Ù‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const container = document.querySelector('.max-w-7xl');
            if (container) {
                container.insertAdjacentHTML('afterbegin', verificationHtml);
            }
        }

        async function verifyReceipt(event) {
            event.preventDefault();
            const code = document.getElementById('receipt-code').value.trim().toUpperCase();
            const resultDiv = document.getElementById('receipt-result');
            
            resultDiv.innerHTML = '<div class="flex items-center justify-center h-full"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-500"></div></div>';
            
            try {
                const allData = await getAllData();
                const order = allData.orders.find(o => (o.verification_code || o.verificationCode || '').toUpperCase() === code);
                
                if (order) {
                    const statusColor = order.status === 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' ? 'green' : 'yellow';
                    const statusIcon = order.status === 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' ? 'âœ…' : 'â³';
                    
                    resultDiv.innerHTML = `
                        <div class="space-y-4">
                            <div class="flex items-center justify-between border-b border-gray-700 pb-4">
                                <h4 class="text-2xl font-bold text-${statusColor}-400">${statusIcon} Ø¥ÙŠØµØ§Ù„ ØµØ­ÙŠØ­</h4>
                                <span class="px-3 py-1 bg-${statusColor}-600 text-white rounded-full text-sm">${order.status}</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span>
                                    <span class="text-white font-mono">${order.id}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</span>
                                    <span class="text-white font-bold">${order.customer_name || order.customerName}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span>
                                    <span class="text-white">${order.customer_phone || order.customerPhone}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ø§Ù„Ø¨Ø±ÙŠØ¯:</span>
                                    <span class="text-white">${order.customer_email || order.customerEmail}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„:</span>
                                    <span class="text-yellow-400 font-mono">${order.transaction_id || order.transactionId}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                                    <span class="text-cyan-400 font-bold text-xl">${order.total}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                                    <span class="text-white">${new Date(order.created_at || order.createdAt).toLocaleString('ar-SA')}</span>
                                </div>
                            </div>
                            <div class="border-t border-gray-700 pt-4">
                                <p class="text-gray-400 mb-2">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</p>
                                <ul class="space-y-1">
                                    ${order.items.map(item => `<li class="text-white">â€¢ ${item.name} (${item.quantity}x)</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                    showToast('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠØµØ§Ù„!', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-red-400">
                            <svg class="w-24 h-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-2xl font-bold mb-2">âŒ Ø¥ÙŠØµØ§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­</p>
                            <p class="text-gray-400">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯</p>
                            <p class="text-sm text-gray-500 mt-2">Ø§Ù„ÙƒÙˆØ¯: ${code}</p>
                        </div>
                    `;
                    showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠØµØ§Ù„', 'error');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚:', error);
                resultDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-red-400">
                        <p class="text-xl font-bold">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚</p>
                        <p class="text-gray-400 mt-2">${error.message}</p>
                    </div>
                `;
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙŠØµØ§Ù„', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
        async function updateSaleSettings() {
            const isActive = document.getElementById('sale-active-toggle').checked;
            const percentage = parseFloat(document.getElementById('sale-percentage-input').value) || 0;
            const text = document.getElementById('sale-text-input').value;
            const color = document.getElementById('sale-color-input').value;

            if (percentage < 0 || percentage > 100) {
                showToast('Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 100.', 'error');
                return;
            }
            
            try {
                await supabaseAdmin.updateSettings('sale', { isActive, percentage, text, color });
                showToast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                renderAdminPage();
            } catch (e) {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        async function updateFeaturedProducts() {
            const isActive = document.getElementById('featured-active-toggle').checked;
            const startDate = document.getElementById('featured-start-date').value;
            const endDate = document.getElementById('featured-end-date').value;
            const selectedProducts = [];
            
            document.querySelectorAll('.featured-product-checkbox:checked').forEach(checkbox => {
                selectedProducts.push({
                    id: parseInt(checkbox.value),
                    category: checkbox.dataset.category
                });
            });
            
            try {
                await supabaseAdmin.updateSettings('featuredProducts', {
                    isActive,
                    products: selectedProducts,
                    startDate: startDate || null,
                    endDate: endDate || null
                });
                showToast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                renderAdminPage();
            } catch (e) {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©
        async function updateMaintenanceSettings() {
            const isActive = document.getElementById('maintenance-active-toggle').checked;
            const message = document.getElementById('maintenance-message-input').value;

            if (isActive && !message.trim()) {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©.', 'error');
                return;
            }

            try {
                await supabaseAdmin.updateSettings('maintenanceMode', { isActive, message });
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¬Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                renderAdminPage();
            } catch (e) {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…ØªØ¬Ø± ÙƒØ£Ø¯Ù…Ù†
        function previewStoreAsAdmin() {
            const token = 'admin_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('admin_preview_token', token);
            window.open(`index.html?admin_preview=${token}`, '_blank');
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø®ØµÙ…
        async function addDiscountCode(event) {
            event.preventDefault();
            const form = event.target;
            const code = form.code.value.trim().toUpperCase();
            const percentage = parseFloat(form.percentage.value);

            if (!code || !percentage || percentage <= 0 || percentage > 100) {
                showToast('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ ØµØ­ÙŠØ­ ÙˆÙ†Ø³Ø¨Ø© Ø®ØµÙ… Ø¨ÙŠÙ† 1 Ùˆ 100.', 'error');
                return;
            }

            const targetType = form.targetType.value;
            let targetValue = null;
            if (targetType === 'section') {
                targetValue = form.targetSection.value;
            } else if (targetType === 'product') {
                targetValue = parseInt(form.targetProduct.value);
            }

            const target = { type: targetType, value: targetValue };
            const newCode = { code, percentage, target, used_by: [] };

            try {
                const allData = await getAllData();
                const existingCodes = allData.discountCodes || [];
                if (existingCodes.some(c => c.code === code)) {
                    showToast('Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.', 'error');
                    return;
                }
                await supabaseAdmin.addDiscountCode(newCode);
                showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                form.reset();
                await renderAdminPage();
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…:', e);
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…: ' + e.message, 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù ÙƒÙˆØ¯ Ø®ØµÙ…
        async function deleteDiscountCode(codeId) {
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…ØŸ`)) {
                try {
                    await supabaseAdmin.deleteDiscountCode(codeId);
                    showToast('ØªÙ… Ø­Ø°Ù ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    renderAdminPage();
                } catch (e) {
                    showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…', 'error');
                }
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
        async function addProduct(pageKey, event) {
            event.preventDefault();
            if (!hasPermission('products_edit')) {
                showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª', 'error');
                return;
            }
            const form = event.target;
            const formData = new FormData(form);
            const newProductData = {};
            const imageUrls = [];

            for (let [key, value] of formData.entries()) {
                if (key === 'price' || key === 'stock') {
                    newProductData[key] = parseFloat(value);
                } else if (key === 'imageUrl[]') {
                    if (value && value.trim()) imageUrls.push(value.trim());
                } else if (key !== 'youtubeUrl' && key !== 'rental_start_date' && key !== 'rental_duration_days') {
                    newProductData[key] = value;
                }
            }
            
            if (imageUrls.length === 0) {
                showToast('ÙŠØ¬Ø¨ Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }
            
            newProductData.image_urls = imageUrls;
            newProductData.image_url = imageUrls[0];
            newProductData.youtube_url = formData.get('youtubeUrl') || '';
            newProductData.total_rating = 0;
            newProductData.rating_count = 0;
            
            if (!newProductData.status) {
                newProductData.status = 'Ù…ØªÙˆÙØ±';
            }
            
            if (pageKey === 'investments' && newProductData.status === 'Ù…Ø¤Ø¬Ø±') {
                newProductData.rental_start_date = formData.get('rental_start_date') || null;
                newProductData.rental_duration_days = formData.get('rental_duration_days') ? parseInt(formData.get('rental_duration_days')) : null;
            } else if (pageKey === 'investments') {
                newProductData.rental_start_date = null;
                newProductData.rental_duration_days = null;
            }

            try {
                const tableMap = {vehicles: 'vehicles', investments: 'investments', sponsors: 'sponsors', moneyServices: 'money_services', banJail: 'ban_jail'};
                await supabaseAdmin.addProduct(tableMap[pageKey], newProductData);
                showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                form.reset();
                await renderAdminPage();
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬:', e);
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬: ' + e.message, 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬
        async function updateProduct(pageKey, productId, event) {
            event.preventDefault();
            if (!hasPermission('products_edit')) {
                showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª', 'error');
                return;
            }
            const form = event.target;
            const formData = new FormData(form);
            const updatedProductData = {};
            const imageUrls = [];

            for (let [key, value] of formData.entries()) {
                 if (key === 'price' || key === 'stock') {
                    updatedProductData[key] = parseFloat(value);
                } else if (key === 'imageUrl[]') {
                    if (value.trim()) imageUrls.push(value.trim());
                } else {
                    updatedProductData[key] = value;
                }
            }
            
            updatedProductData.image_urls = imageUrls;
            updatedProductData.image_url = imageUrls[0] || '';
            updatedProductData.youtube_url = updatedProductData.youtubeUrl || '';
            delete updatedProductData.youtubeUrl;

            try {
                const tableMap = {vehicles: 'vehicles', investments: 'investments', sponsors: 'sponsors', moneyServices: 'money_services', banJail: 'ban_jail'};
                await supabaseAdmin.updateProduct(tableMap[pageKey], productId, updatedProductData);
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                renderAdminPage();
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬:', e);
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬: ' + (e.message || e), 'error');
            }
        }

        // Ø­Ø°Ù Ù…Ù†ØªØ¬
        async function deleteProduct(pageKey, productId) {
            if (!hasPermission('products_edit')) {
                showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù…Ù†ØªØ¬Ø§Øª', 'error');
                return;
            }
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) {
                try {
                    const tableMap = {vehicles: 'vehicles', investments: 'investments', sponsors: 'sponsors', moneyServices: 'money_services', banJail: 'ban_jail'};
                    await supabaseAdmin.deleteProduct(tableMap[pageKey], productId);
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    renderAdminPage();
                } catch (e) {
                    showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'error');
                }
            }
        }

        // Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª - Ù…Ø¹Ø·Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù…Ø¹ Supabase
        let draggedItem = null;
        
        function dragStart(event, pageKey, productId) {
            showToast('Ù…ÙŠØ²Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'info');
            event.preventDefault();
        }
        
        function dragOver(event) {
            event.preventDefault();
        }
        
        async function dragDrop(event, pageKey, targetIndex) {
            event.preventDefault();
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù†Ù‚Ù„ Ù…Ù†ØªØ¬ Ø¨ÙŠÙ† Ø§Ù„ÙØ¦Ø§Øª - Ù…Ø¹Ø·Ù„Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
        async function moveProduct(originalPageKey, productId, destinationPageKey) {
            showToast('Ù…ÙŠØ²Ø© Ù†Ù‚Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'info');
            renderAdminPage();
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ø·Ù„Ø¨ (Ø¨Ø¹Ø¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…)
        async function completeOrder(orderId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ Ù‚Ù…Øª Ø¨ØªØ³Ù„ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„ØŸ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡ Ø¥Ù„Ù‰ "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…".')) {
                try {
                    await supabaseAdmin.updateOrderStatus(orderId, 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…');
                    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨!', 'success');
                    renderAdminPage();
                } catch (e) {
                    showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨', 'error');
                }
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ø·Ù„Ø¨ (Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ø§Ø±Ø¦Ø©)
        async function deleteOrder(orderId) {
            if (confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                try {
                    await supabaseAdmin.deleteOrder(orderId);
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    renderAdminPage();
                } catch (e) {
                    showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨', 'error');
                }
            }
        }

        // === Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„ØµÙˆØ± ===
        const IMGBB_API_KEY = '1accc8b95e84bda05217c15d4f6add32';
        
        // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹
        function compressImage(file, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function uploadImage(input, category) {
            const file = input.files[0];
            if (!file) return;
            
            const hiddenInput = input.parentElement.querySelector('input[type="hidden"]');
            let loadingMsg = input.parentElement.querySelector('.upload-status');
            if (!loadingMsg) {
                loadingMsg = document.createElement('span');
                loadingMsg.className = 'upload-status text-cyan-400 text-sm';
                input.parentElement.appendChild(loadingMsg);
            }
            loadingMsg.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„Ø±ÙØ¹...';
            loadingMsg.className = 'upload-status text-cyan-400 text-sm animate-pulse';
            
            try {
                // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©
                const compressedBlob = await compressImage(file);
                
                const formData = new FormData();
                formData.append('image', compressedBlob, 'image.jpg');
                formData.append('key', IMGBB_API_KEY);
                
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.data.url) {
                    hiddenInput.value = result.data.url;
                    loadingMsg.textContent = 'âœ“ ØªÙ… Ø§Ù„Ø±ÙØ¹';
                    loadingMsg.className = 'upload-status text-green-400 text-sm font-bold';
                    showToast('ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } else {
                    throw new Error(result.error?.message || 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:', error);
                loadingMsg.textContent = 'âœ— ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹';
                loadingMsg.className = 'upload-status text-red-400 text-sm';
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message, 'error');
            }
        }
        
        function addImageField(button) {
            const container = button.previousElementSibling;
            const form = container.closest('form');
            const pageKey = form.getAttribute('onsubmit')?.match(/'([^']+)'/)?.[1] || 'general';
            const newField = document.createElement('div');
            newField.className = 'flex gap-2 mb-2';
            newField.innerHTML = `
                <input type="file" accept="image/*" onchange="uploadImage(this, '${pageKey}')" class="input-field flex-1">
                <input name="imageUrl[]" type="hidden">
                <button type="button" onclick="removeImageField(this)" class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded">Ø­Ø°Ù</button>
            `;
            container.appendChild(newField);
        }

        function removeImageField(button) {
            const container = button.closest('.image-urls-container');
            if (container && container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        function addEditImageField() {
            const container = document.getElementById('edit-image-urls-container');
            const form = container.closest('form');
            const pageKey = form.getAttribute('onsubmit').match(/'([^']+)'/)[1];
            const newField = document.createElement('div');
            newField.className = 'flex gap-2 mb-2';
            newField.innerHTML = `
                <input type="file" accept="image/*" onchange="uploadImage(this, '${pageKey}')" class="input-field flex-1">
                <input name="imageUrl[]" type="hidden">
                <button type="button" onclick="removeEditImageField(this)" class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded">Ø­Ø°Ù</button>
            `;
            container.appendChild(newField);
        }

        function removeEditImageField(button) {
            const container = document.getElementById('edit-image-urls-container');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        // === Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ===

        // ÙˆØ¸ÙŠÙØ© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        function formatAdminPrice(price, currency) {
            const numericPrice = parseFloat(price);
            if (isNaN(numericPrice)) {
                return 'N/A';
            }
            const currencySymbols = {
                'USD': '$',
                'SAR': 'Ø±ÙŠØ§Ù„',
                'AED': 'Ø¯.Ø¥',
                'KWD': 'Ø¯.Ùƒ',
                'BHD': 'Ø¯.Ø¨',
                'OMR': 'Ø±.Ø¹',
                'QAR': 'Ø±.Ù‚',
                'IQD': 'Ø¯.Ø¹',
                'JOD': 'Ø¯.Ø£'
            };
            const formattedPrice = numericPrice.toLocaleString('ar-SA');
            return `${formattedPrice} ${currencySymbols[currency] || currency}`;
        }

        // ÙˆØ¸ÙŠÙØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        function formatAdminRating(product) {
            const ratingCount = product.rating_count || product.ratingCount || 0;
            if (ratingCount > 0) {
                const totalRating = product.total_rating || product.totalRating || 0;
                const averageRating = totalRating / ratingCount;
                return ` | â˜… ${averageRating.toFixed(1)} (${ratingCount})`;
            }
            return '';
        }

        // ÙˆØ¸ÙŠÙØ© Ù„ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬
        function getStatusColor(status) {
            switch(status) {
                case 'Ù…ØªÙˆÙØ±': return 'text-green-400';
                case 'Ù…Ø¨Ø§Ø¹': return 'text-red-400';
                case 'Ù…Ø¤Ø¬Ø±': return 'text-orange-400';
                case 'ØºÙŠØ± Ù…ØªÙˆÙØ±': return 'text-gray-400';
                default: return 'text-green-400';
            }
        }

        // ÙˆØ¸ÙŠÙØ© Ù„ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬
        function getStatusIcon(status) {
            switch(status) {
                case 'Ù…ØªÙˆÙØ±': return 'âœ…';
                case 'Ù…Ø¨Ø§Ø¹': return 'ğŸ”´';
                case 'Ù…Ø¤Ø¬Ø±': return 'ğŸ’¼';
                case 'ØºÙŠØ± Ù…ØªÙˆÙØ±': return 'âš«';
                default: return 'âœ…';
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ£Ø¬ÙŠØ±
        function toggleRentalFields(selectElement, formType) {
            const rentalFields = document.getElementById(`rental-fields-${formType}`);
            if (selectElement.value === 'Ù…Ø¤Ø¬Ø±') {
                rentalFields.classList.remove('hidden');
            } else {
                rentalFields.classList.add('hidden');
            }
        }

        // ÙˆØ¸Ø§Ø¦Ù Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
        function previewImage(imageUrl, productName) {
            document.getElementById('preview-image').src = imageUrl;
            document.getElementById('preview-title').textContent = productName;
            document.getElementById('image-preview-modal').classList.remove('hidden');
        }

        function closeImagePreview() {
            document.getElementById('image-preview-modal').classList.add('hidden');
        }

        // ÙˆØ¸ÙŠÙØ© Ù„Ø¹Ø±Ø¶ Ø§Ø³Ù… Ù‡Ø¯Ù Ø§Ù„Ø®ØµÙ…
        function getDiscountTargetName(target, allProducts) {
            if (!target || target.type === 'all') return 'ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª';
            if (target.type === 'section') return `Ù‚Ø³Ù…: ${getPageTitle(target.value)}`;
            if (target.type === 'product') {
                for (const key in allProducts) {
                    if (Array.isArray(allProducts[key]) && getPageTitle(key)) {
                        const product = allProducts[key].find(p => p.id === target.value);
                        if (product) return `Ù…Ù†ØªØ¬: ${product.name}`;
                    }
                }
                return 'Ù…Ù†ØªØ¬ Ù…Ø­Ø°ÙˆÙ';
            }
            return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        }

        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function getPageTitle(pageKey) {
            const titles = {
                vehicles: 'Ù…Ø±ÙƒØ¨Ø§Øª Ø¨ÙƒØ³Ù„',
                investments: 'ÙØ±Øµ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±',
                sponsors: 'Ø±ÙˆØ§Ø¹ÙŠ Ø¨ÙƒØ³Ù„',
                moneyServices: 'Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£Ù…ÙˆØ§Ù„',
                banJail: 'Ø§Ù„Ø¨Ø§Ù†Ø¯ ÙˆØ§Ù„Ø³Ø¬Ù†'
            };
            return titles[pageKey];
        }

        function getExtraFields(pageKey) {
            let fields = '';
            const commonClass = 'class="input-field"';
            const selectStyle = 'style="color: #000000; background-color: #FFFFFF;"';
            const required = 'required';
            switch (pageKey) {
                case 'vehicles':
                    fields = `<div><label class="block text-sm font-medium text-gray-400 mb-1">ÙØ¦Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><select name="category" required class="input-field w-full" ${selectStyle}>
                                <option value="Ù…ÙˆØ§Ø·Ù†ÙŠÙ†" selected>Ù…Ø±ÙƒØ¨Ø§Øª Ù…ÙˆØ§Ø·Ù†ÙŠÙ†</option>
                                <option value="Ø­ÙƒÙˆÙ…ÙŠØ©">Ù…Ø±ÙƒØ¨Ø§Øª Ø­ÙƒÙˆÙ…ÙŠØ©</option>
                                <option value="Ø´Ø§Ø­Ù†Ø§Øª">Ø´Ø§Ø­Ù†Ø§Øª ÙˆØ­Ù…ÙˆÙ„Ø§Øª</option>
                              </select></div>`;
                    break;
                case 'investments':
                    fields = `<div><label class="block text-sm font-medium text-gray-400 mb-1">ÙØ¦Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</label><select name="category" required class="input-field w-full" ${selectStyle}>
                                <option value="Ø§Ù„Ø¨Ù‚Ø§Ù„Ø§Øª" selected>Ø§Ù„Ø¨Ù‚Ø§Ù„Ø§Øª</option>
                                <option value="Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙˆÙ‚ÙˆØ¯">Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙˆÙ‚ÙˆØ¯</option>
                                <option value="Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª</option>
                                <option value="Ù…Ø­Ù„ Ø§Ù„Ø§Ø³Ù„Ø­Ø©">Ù…Ø­Ù„ Ø§Ù„Ø§Ø³Ù„Ø­Ø©</option>
                                <option value="ÙˆØ±Ø´ Ø§Ù„ØªØ²ÙˆÙŠØ¯">ÙˆØ±Ø´ Ø§Ù„ØªØ²ÙˆÙŠØ¯</option>
                                <option value="Ø§Ù„Ø¨Ø§Ø±">Ø§Ù„Ø¨Ø§Ø±</option>
                              </select></div>
                              <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label><select name="region" required class="input-field w-full" ${selectStyle}>
                                <option value="Ù„ÙˆØ³" selected>Ù„ÙˆØ³</option>
                                <option value="Ø³Ø§Ù†Ø¯ÙŠ">Ø³Ø§Ù†Ø¯ÙŠ</option>
                                <option value="Ø¨ÙˆÙ„ÙŠØªÙˆ">Ø¨ÙˆÙ„ÙŠØªÙˆ</option>
                                <option value="Ø¬Ø²ÙŠØ±Ø© Ø¨ÙˆÙ„ÙŠØªÙˆ">Ø¬Ø²ÙŠØ±Ø© Ø¨ÙˆÙ„ÙŠØªÙˆ</option>
                                <option value="Ø¬Ø²ÙŠØ±Ø© ÙØ±Ø³Ø§Ù†">Ø¬Ø²ÙŠØ±Ø© ÙØ±Ø³Ø§Ù†</option>
                              </select></div>
                              <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„Ù…Ø±Ø¨Ø¹</label><input name="square" type="text" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¨Ø¹" class="input-field w-full"></div>`;
                    break;
                case 'sponsors':
                    fields = ``;
                    break;
                case 'moneyServices':
                    fields = ``;
                    break;
                case 'banJail':
                    fields = ``;
                    break;
            }
            return fields;
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        async function showEditForm(pageKey, productId) {
            const allProducts = await getAllData();
            const product = allProducts[pageKey].find(p => p.id === productId);
            const selectStyle = 'style="color: #000000; background-color: #FFFFFF;"';
            if (!product) return;

            const productContainer = document.getElementById(`product-item-${pageKey}-${productId}`);
            if (!productContainer) return;

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const isUsdSelected = product.currency === 'USD' ? 'selected' : '';
            const isSarSelected = product.currency === 'SAR' ? 'selected' : '';

            // Ø¬Ù„Ø¨ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
            const imageUrls = product.image_urls || product.imageUrls || [product.image_url || product.imageUrl].filter(Boolean);
            const youtubeUrl = product.youtube_url || product.youtubeUrl || '';

            // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø¹ Ù‚ÙŠÙ…Ù‡Ø§ Ø§Ù„ØµØ­ÙŠØ­Ø©
            let extraFieldsHtml = '';
            if (pageKey === 'vehicles') {
                const cat1 = product.category === 'Ù…ÙˆØ§Ø·Ù†ÙŠÙ†' ? 'selected' : '';
                const cat2 = product.category === 'Ø­ÙƒÙˆÙ…ÙŠØ©' ? 'selected' : '';
                const cat3 = product.category === 'Ø´Ø§Ø­Ù†Ø§Øª' ? 'selected' : '';
                extraFieldsHtml = `<div><label class="block text-sm font-medium text-gray-400 mb-1">ÙØ¦Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label><select name="category" required class="input-field w-full" ${selectStyle}>
                                        <option value="Ù…ÙˆØ§Ø·Ù†ÙŠÙ†" ${cat1}>Ù…Ø±ÙƒØ¨Ø§Øª Ù…ÙˆØ§Ø·Ù†ÙŠÙ†</option>
                                        <option value="Ø­ÙƒÙˆÙ…ÙŠØ©" ${cat2}>Ù…Ø±ÙƒØ¨Ø§Øª Ø­ÙƒÙˆÙ…ÙŠØ©</option>
                                        <option value="Ø´Ø§Ø­Ù†Ø§Øª" ${cat3}>Ø´Ø§Ø­Ù†Ø§Øª ÙˆØ­Ù…ÙˆÙ„Ø§Øª</option>
                                   </select></div>`;
            } else if (pageKey === 'investments') {
                const cat1 = product.category === 'Ø§Ù„Ø¨Ù‚Ø§Ù„Ø§Øª' ? 'selected' : '';
                const cat2 = product.category === 'Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙˆÙ‚ÙˆØ¯' ? 'selected' : '';
                const cat3 = product.category === 'Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª' ? 'selected' : '';
                const cat4 = product.category === 'Ù…Ø­Ù„ Ø§Ù„Ø§Ø³Ù„Ø­Ø©' ? 'selected' : '';
                const cat5 = product.category === 'ÙˆØ±Ø´ Ø§Ù„ØªØ²ÙˆÙŠØ¯' ? 'selected' : '';
                const cat6 = product.category === 'Ø§Ù„Ø¨Ø§Ø±' ? 'selected' : '';
                const reg1 = product.region === 'Ù„ÙˆØ³' ? 'selected' : '';
                const reg2 = product.region === 'Ø³Ø§Ù†Ø¯ÙŠ' ? 'selected' : '';
                const reg3 = product.region === 'Ø¨ÙˆÙ„ÙŠØªÙˆ' ? 'selected' : '';
                const reg4 = product.region === 'Ø¬Ø²ÙŠØ±Ø© Ø¨ÙˆÙ„ÙŠØªÙˆ' ? 'selected' : '';
                const reg5 = product.region === 'Ø¬Ø²ÙŠØ±Ø© ÙØ±Ø³Ø§Ù†' ? 'selected' : '';
                extraFieldsHtml = `<div><label class="block text-sm font-medium text-gray-400 mb-1">ÙØ¦Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</label><select name="category" required class="input-field w-full" ${selectStyle}>
                                        <option value="Ø§Ù„Ø¨Ù‚Ø§Ù„Ø§Øª" ${cat1}>Ø§Ù„Ø¨Ù‚Ø§Ù„Ø§Øª</option>
                                        <option value="Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙˆÙ‚ÙˆØ¯" ${cat2}>Ù…Ø­Ø·Ø§Øª Ø§Ù„ÙˆÙ‚ÙˆØ¯</option>
                                        <option value="Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª" ${cat3}>Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª</option>
                                        <option value="Ù…Ø­Ù„ Ø§Ù„Ø§Ø³Ù„Ø­Ø©" ${cat4}>Ù…Ø­Ù„ Ø§Ù„Ø§Ø³Ù„Ø­Ø©</option>
                                        <option value="ÙˆØ±Ø´ Ø§Ù„ØªØ²ÙˆÙŠØ¯" ${cat5}>ÙˆØ±Ø´ Ø§Ù„ØªØ²ÙˆÙŠØ¯</option>
                                        <option value="Ø§Ù„Ø¨Ø§Ø±" ${cat6}>Ø§Ù„Ø¨Ø§Ø±</option>
                                   </select></div>
                                   <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label><select name="region" required class="input-field w-full" ${selectStyle}>
                                        <option value="Ù„ÙˆØ³" ${reg1}>Ù„ÙˆØ³</option>
                                        <option value="Ø³Ø§Ù†Ø¯ÙŠ" ${reg2}>Ø³Ø§Ù†Ø¯ÙŠ</option>
                                        <option value="Ø¨ÙˆÙ„ÙŠØªÙˆ" ${reg3}>Ø¨ÙˆÙ„ÙŠØªÙˆ</option>
                                        <option value="Ø¬Ø²ÙŠØ±Ø© Ø¨ÙˆÙ„ÙŠØªÙˆ" ${reg4}>Ø¬Ø²ÙŠØ±Ø© Ø¨ÙˆÙ„ÙŠØªÙˆ</option>
                                        <option value="Ø¬Ø²ÙŠØ±Ø© ÙØ±Ø³Ø§Ù†" ${reg5}>Ø¬Ø²ÙŠØ±Ø© ÙØ±Ø³Ø§Ù†</option>
                                   </select></div>
                                   <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„Ù…Ø±Ø¨Ø¹</label><input name="square" type="text" value="${product.square || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¨Ø¹" class="input-field w-full"></div>`;
            } else if (pageKey === 'sponsors') {
                extraFieldsHtml = ``;
            } else if (pageKey === 'moneyServices') {
                extraFieldsHtml = ``;
            } else if (pageKey === 'banJail') {
                extraFieldsHtml = ``;
            }

            const editFormHtml = `
                <form onsubmit="updateProduct('${pageKey}', ${productId}, event)" class="w-full p-4 bg-gray-700 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-x-4 gap-y-6">
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„Ø§Ø³Ù…</label><input name="name" type="text" value="${product.name}" required class="input-field w-full"></div>
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„Ø³Ø¹Ø±</label><input name="price" type="number" step="any" value="${product.price}" required class="input-field w-full"></div>
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„Ø¹Ù…Ù„Ø©</label><select name="currency" required class="input-field w-full" ${selectStyle}>
                            <option value="USD" ${product.currency === 'USD' ? 'selected' : ''}>Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ ($)</option>
                            <option value="SAR" ${product.currency === 'SAR' ? 'selected' : ''}>Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ (Ø±ÙŠØ§Ù„)</option>
                            <option value="AED" ${product.currency === 'AED' ? 'selected' : ''}>Ø§Ù„Ø¯Ø±Ù‡Ù… Ø§Ù„Ø¥Ù…Ø§Ø±Ø§ØªÙŠ (Ø¯.Ø¥)</option>
                            <option value="KWD" ${product.currency === 'KWD' ? 'selected' : ''}>Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„ÙƒÙˆÙŠØªÙŠ (Ø¯.Ùƒ)</option>
                            <option value="BHD" ${product.currency === 'BHD' ? 'selected' : ''}>Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†ÙŠ (Ø¯.Ø¨)</option>
                            <option value="OMR" ${product.currency === 'OMR' ? 'selected' : ''}>Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø¹Ù…Ø§Ù†ÙŠ (Ø±.Ø¹)</option>
                            <option value="QAR" ${product.currency === 'QAR' ? 'selected' : ''}>Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ù‚Ø·Ø±ÙŠ (Ø±.Ù‚)</option>
                            <option value="IQD" ${product.currency === 'IQD' ? 'selected' : ''}>Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ (Ø¯.Ø¹)</option>
                            <option value="JOD" ${product.currency === 'JOD' ? 'selected' : ''}>Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ (Ø¯.Ø£)</option>
                        </select>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input name="stock" type="number" value="${product.stock}" required class="input-field w-full"></div>
                        <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬</label><select name="status" required class="input-field w-full" ${selectStyle} onchange="toggleRentalFields(this, 'edit-${pageKey}-${productId}')">
                            <option value="Ù…ØªÙˆÙØ±" ${(product.status || 'Ù…ØªÙˆÙØ±') === 'Ù…ØªÙˆÙØ±' ? 'selected' : ''}>Ù…ØªÙˆÙØ±</option>
                            <option value="Ù…Ø¨Ø§Ø¹" ${product.status === 'Ù…Ø¨Ø§Ø¹' ? 'selected' : ''}>Ù…Ø¨Ø§Ø¹</option>
                            <option value="Ù…Ø¤Ø¬Ø±" ${product.status === 'Ù…Ø¤Ø¬Ø±' ? 'selected' : ''}>Ù…Ø¤Ø¬Ø±</option>
                            <option value="ØºÙŠØ± Ù…ØªÙˆÙØ±" ${product.status === 'ØºÙŠØ± Ù…ØªÙˆÙØ±' ? 'selected' : ''}>ØºÙŠØ± Ù…ØªÙˆÙØ±</option>
                        </select></div>
                        <div id="rental-fields-edit-${pageKey}-${productId}" class="md:col-span-4 ${product.status === 'Ù…Ø¤Ø¬Ø±' ? '' : 'hidden'}">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-orange-900/20 p-4 rounded-lg border border-orange-500">
                                <div><label class="block text-sm font-medium text-orange-400 mb-1">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„ØªØ£Ø¬ÙŠØ±</label><input name="rental_start_date" type="date" value="${product.rental_start_date ? product.rental_start_date.split('T')[0] : ''}" class="input-field w-full"></div>
                                <div><label class="block text-sm font-medium text-orange-400 mb-1">Ù…Ø¯Ø© Ø§Ù„ØªØ£Ø¬ÙŠØ± (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label><input name="rental_duration_days" type="number" min="1" value="${product.rental_duration_days || ''}" placeholder="Ù…Ø«Ø§Ù„: 30" class="input-field w-full"></div>
                            </div>
                        </div>
                        <div class="md:col-span-4">
                            <label class="block text-sm font-medium text-gray-400 mb-1">ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</label>
                            <textarea name="description" class="input-field w-full h-24 resize-none">${product.description || ''}</textarea>
                        </div>
                        <div class="md:col-span-4">
                            <label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
                            <div id="edit-image-urls-container">
                                ${imageUrls.map((url, index) => `
                                    <div class="flex gap-2 mb-2 items-center">
                                        <img src="${url}" class="w-16 h-16 object-cover rounded" onerror="this.style.display='none'">
                                        <input name="imageUrl[]" type="hidden" value="${url}">
                                        <span class="text-gray-400 text-sm flex-1 truncate">${url.split('/').pop()}</span>
                                        <button type="button" onclick="removeEditImageField(this)" class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded" ${index === 0 ? 'style="display:none;"' : ''}>Ø­Ø°Ù</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button type="button" onclick="addEditImageField()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded mt-2">Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                        </div>
                        <div class="md:col-span-4">
                            <label class="block text-sm font-medium text-gray-400 mb-1">Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input name="youtubeUrl" type="url" value="${youtubeUrl}" placeholder="https://www.youtube.com/watch?v=..." class="input-field w-full">
                            <p class="text-xs text-gray-500 mt-1">Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±</p>
                        </div>
                        ${extraFieldsHtml}
                    </div>
                    <div class="flex gap-4 mt-4 justify-end">
                        <button type="button" onclick="initializeAdminPanel()" class="bg-gray-500 hover:bg-gray-400 text-white font-bold py-2 px-4 rounded">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    </div>
                </form>
            `;
            productContainer.innerHTML = editFormHtml;
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù†Ù‚Ù„
        function showMoveOptions(pageKey, productId) {
            const productContainer = document.getElementById(`product-item-${pageKey}-${productId}`);
            if (!productContainer) return;

            const selectStyle = 'style="color: #000000; background-color: #FFFFFF;"';
            const allCategories = Object.keys(initialProductStructure);
            const optionsHtml = allCategories
                .filter(key => getPageTitle(key)) // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ØºÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                .map(key => `<option value="${key}" ${key === pageKey ? 'disabled' : ''}>${getPageTitle(key)}</option>`)
                .join('');

            const moveFormHtml = `
                <div class="w-full p-4 bg-gray-700 rounded-lg flex items-center justify-between gap-4">
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                        <select id="move-destination-${productId}" class="input-field w-full" ${selectStyle}>
                            <option value="">-- Ø§Ø®ØªØ± Ù‚Ø³Ù…Ø§Ù‹ --</option>
                            ${optionsHtml}
                        </select>
                    </div>
                    <div class="flex gap-2 mt-5">
                        <button type="button" onclick="initializeAdminPanel()" class="bg-gray-500 hover:bg-gray-400 text-white font-bold py-2 px-4 rounded">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="button" onclick="moveProduct('${pageKey}', ${productId}, document.getElementById('move-destination-${productId}').value)" class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„</button>
                    </div>
                </div>
            `;
            productContainer.innerHTML = moveFormHtml;
        }

        // Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        async function renderAdminPage() {
            const allProducts = await getAllData();
            console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:', allProducts);
            let adminHtml = `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <div class="flex justify-between items-center mb-10">
                        <h2 class="text-5xl font-extrabold text-white text-center">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                        <a href="index.html" class="text-cyan-400 hover:text-white transition">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø± &rarr;</a>
                    </div>
            `;

            // Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶
            if (hasPermission('settings')) {
            const sale = allProducts.sale || { isActive: false, percentage: 0, text: 'ğŸ‰ Ø¹Ø±Ø¶ Ø®Ø§Øµ! Ø®ØµÙ… {percentage}% Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª!', color: '#f59e0b' };
            adminHtml += `
                <div class="bg-gray-900 p-6 rounded-xl shadow-lg border border-yellow-500 mb-8">
                    <h3 class="text-3xl font-bold text-yellow-400 mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª</h3>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                            <div class="flex items-center gap-3">
                                <label for="sale-active-toggle" class="font-semibold text-lg text-white">Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶:</label>
                                <input type="checkbox" id="sale-active-toggle" class="w-6 h-6" ${sale.isActive ? 'checked' : ''}>
                                <span class="text-gray-400">${sale.isActive ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…ØªÙˆÙ‚Ù'}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <label for="sale-percentage-input" class="font-semibold text-lg text-white">Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%):</label>
                                <input type="number" id="sale-percentage-input" min="0" max="100" value="${sale.percentage}" class="input-field w-24 text-center">
                            </div>
                             <div class="flex items-center gap-3">
                                <label for="sale-color-input" class="font-semibold text-lg text-white">Ù„ÙˆÙ† Ø§Ù„Ø´Ø±ÙŠØ·:</label>
                                <input type="color" id="sale-color-input" value="${sale.color || '#f59e0b'}" class="input-field h-10 w-16 p-1">
                            </div>
                        </div>
                        <div>
                            <label for="sale-text-input" class="font-semibold text-lg text-white mb-2 block">Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø§Ø³ØªØ®Ø¯Ù… {percentage} Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø¨Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®ØµÙ…):</label>
                            <input type="text" id="sale-text-input" value="${sale.text || ''}" class="input-field w-full" placeholder="Ù…Ø«Ø§Ù„: ğŸ‰ Ø¹Ø±Ø¶ Ø®Ø§Øµ! Ø£Ùˆ ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù† Ù…Ù‡Ù…!">
                            <p class="text-xs text-gray-400 mt-1">ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙŠØ· Ø¨Ø¯ÙˆÙ† Ø®ØµÙ… ÙƒØ¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ø¯ÙŠ</p>
                        </div>
                        <button onclick="updateSaleSettings()" class="w-full md:w-auto bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg transition">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                    </div>
                </div>
            `;

            }
            
            // Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©
            if (hasPermission('settings')) {
            const maintenance = allProducts.maintenanceMode || { isActive: false, message: 'Ù†Ø­Ù† Ù†Ù‚ÙˆÙ… Ø¨Ø¨Ø¹Ø¶ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. Ø³Ù†Ø¹ÙˆØ¯ Ù‚Ø±ÙŠØ¨Ø§Ù‹!' };
            adminHtml += `
                <div class="bg-gray-900 p-6 rounded-xl shadow-lg border border-red-500 mb-8">
                    <h3 class="text-3xl font-bold text-red-400 mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¬Ø±</h3>
                    <div class="space-y-6">
                        <div class="flex items-center gap-3">
                            <label for="maintenance-active-toggle" class="font-semibold text-lg text-white">ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©:</label>
                            <input type="checkbox" id="maintenance-active-toggle" class="w-6 h-6" ${maintenance.isActive ? 'checked' : ''}>
                            <span class="text-gray-400">${maintenance.isActive ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…ØªÙˆÙ‚Ù'}</span>
                        </div>
                        <div>
                            <label for="maintenance-message-input" class="font-semibold text-lg text-white mb-2 block">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©:</label>
                            <input type="text" id="maintenance-message-input" value="${maintenance.message}" class="input-field w-full">
                        </div>
                        <div class="flex gap-4">
                            <button onclick="updateMaintenanceSettings()" class="flex-1 md:flex-none bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition">Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©</button>
                            <button onclick="previewStoreAsAdmin()" class="flex-1 md:flex-none bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg transition flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…ØªØ¬Ø± ÙƒØ£Ø¯Ù…Ù†
                            </button>
                        </div>
                    </div>
                </div>
            `;

            }
            
            // Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            if (hasPermission('settings')) {
            const featuredProducts = allProducts.featuredProducts || { isActive: false, products: [], expiryDate: null };
            let allProductsList = [];
            for (const pageKey in allProducts) {
                if (getPageTitle(pageKey) && Array.isArray(allProducts[pageKey])) {
                    allProducts[pageKey].forEach(p => {
                        const imgUrl = p.image_urls?.[0] || p.imageUrls?.[0] || p.image_url || p.imageUrl || '';
                        allProductsList.push({ ...p, imageUrl: imgUrl, category: pageKey, categoryName: getPageTitle(pageKey) });
                    });
                }
            }
            
            adminHtml += `
                <div class="bg-gray-900 p-6 rounded-xl shadow-lg border border-orange-500 mb-8">
                    <h3 class="text-3xl font-bold text-orange-400 mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
                    <div class="space-y-6">
                        <div class="flex items-center gap-3">
                            <label for="featured-active-toggle" class="font-semibold text-lg text-white">Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù…:</label>
                            <input type="checkbox" id="featured-active-toggle" class="w-6 h-6" ${featuredProducts.isActive ? 'checked' : ''}>
                            <span class="text-gray-400">${featuredProducts.isActive ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…ØªÙˆÙ‚Ù'}</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="featured-start-date" class="font-semibold text-lg text-white mb-2 block">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø±Ø¶:</label>
                                <input type="date" id="featured-start-date" value="${featuredProducts.startDate ? featuredProducts.startDate.split('T')[0] : ''}" class="input-field w-full">
                            </div>
                            <div>
                                <label for="featured-end-date" class="font-semibold text-lg text-white mb-2 block">ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø±Ø¶:</label>
                                <input type="date" id="featured-end-date" value="${featuredProducts.endDate ? featuredProducts.endDate.split('T')[0] : ''}" class="input-field w-full">
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold text-lg text-white mb-2 block">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-60 overflow-y-auto">
                                ${allProductsList.map(product => `
                                    <label class="flex items-center gap-3 p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700">
                                        <input type="checkbox" class="featured-product-checkbox" value="${product.id}" data-category="${product.category}" ${featuredProducts.products.some(fp => fp.id === product.id && fp.category === product.category) ? 'checked' : ''}>
                                        <img src="${product.imageUrls ? product.imageUrls[0] : product.imageUrl}" alt="${product.name}" class="w-12 h-12 object-cover rounded">
                                        <div>
                                            <p class="text-white font-semibold">${product.name}</p>
                                            <p class="text-gray-400 text-sm">${product.categoryName}</p>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <button onclick="updateFeaturedProducts()" class="w-full md:w-auto bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 px-6 rounded-lg transition">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                    </div>
                </div>
            `;

            }
            
            // Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ…
            if (hasPermission('discounts')) {
            const discountCodes = allProducts.discountCodes || [];
            let productOptionsForDiscount = '';
            for (const pageKey in allProducts) {
                if (getPageTitle(pageKey)) {
                    productOptionsForDiscount += `<optgroup label="Ù…Ù†ØªØ¬Ø§Øª ${getPageTitle(pageKey)}">`;
                    productOptionsForDiscount += allProducts[pageKey].map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    productOptionsForDiscount += `</optgroup>`;
                }
            }
            adminHtml += `
                <div class="bg-gray-900 p-6 rounded-xl shadow-lg border border-purple-500 mb-8">
                    <h3 class="text-3xl font-bold text-purple-400 mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®ØµÙ…</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-gray-800 p-4 rounded-lg self-start">
                            <h4 class="text-xl font-semibold text-white mb-4">Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h4>
                            <form onsubmit="addDiscountCode(event)" class="space-y-3">
                                <div><label class="text-sm text-gray-400">Ø§Ù„ÙƒÙˆØ¯</label><input name="code" type="text" placeholder="Ù…Ø«Ø§Ù„: WELCOME10" required class="input-field w-full uppercase"></div>
                                <div><label class="text-sm text-gray-400">Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)</label><input name="percentage" type="number" min="1" max="100" placeholder="Ù…Ø«Ø§Ù„: 15" required class="input-field w-full"></div>
                                <div><label class="text-sm text-gray-400">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (0 = ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)</label><input name="limit" type="number" min="0" placeholder="Ù…Ø«Ø§Ù„: 1" required class="input-field w-full"></div>
                                <div>
                                    <label class="text-sm text-gray-400">ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰</label>
                                    <select name="targetType" required class="input-field w-full" onchange="toggleDiscountTargetOptions(this.value)" style="color: #000000; background-color: #FFFFFF;">
                                        <option value="all" selected>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</option>
                                        <option value="section">Ù‚Ø³Ù… Ù…Ø¹ÙŠÙ†</option>
                                        <option value="product">Ù…Ù†ØªØ¬ Ù…Ø¹ÙŠÙ†</option>
                                    </select>
                                </div>
                                <div id="discount-target-section-container" class="hidden">
                                    <label class="text-sm text-gray-400">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</label>
                                    <select name="targetSection" class="input-field w-full" style="color: #000000; background-color: #FFFFFF;">
                                        ${Object.keys(initialProductStructure).filter(k => getPageTitle(k)).map(k => `<option value="${k}">${getPageTitle(k)}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="discount-target-product-container" class="hidden">
                                    <label class="text-sm text-gray-400">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</label>
                                    <select name="targetProduct" class="input-field w-full" style="color: #000000; background-color: #FFFFFF;">
                                        ${productOptionsForDiscount}
                                    </select>
                                </div>
                                <button type="submit" class="w-full btn-primary py-2">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ¯</button>
                            </form>
                        </div>
                        <div class="space-y-3 max-h-96 overflow-y-auto pr-2">
                            <h4 class="text-xl font-semibold text-white mb-4">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
                            ${discountCodes.length > 0 ? discountCodes.map(c => `
                                <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-white">${c.code} <span class="text-purple-400">(${c.percentage}%)</span></p>
                                        <p class="text-xs text-cyan-400">${getDiscountTargetName(c.target, allProducts)}</p>
                                        <p class="text-xs text-gray-400 mt-1">Ù…Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${c.used_by ? c.used_by.length : (c.usedBy ? c.usedBy.length : 0)}</p>
                                    </div>
                                    <button onclick="deleteDiscountCode(${c.id})" class="flex-shrink-0 text-red-500 hover:text-red-400 p-2 rounded-full bg-gray-900 hover:bg-gray-700 transition" title="Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                    </button>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ø®ØµÙ… Ø­Ø§Ù„ÙŠØ§Ù‹.</p>'} 
                        </div>
                    </div>
                </div>
            `;

            }
            
            // --- START OF NEW LOGIC ---
            if (hasPermission('orders')) {
            const allOrders = allProducts.orders || [];
            const pendingOrders = allOrders.filter(o => o.status !== 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…').sort((a, b) => new Date(b.created_at || b.createdAt) - new Date(a.created_at || a.createdAt));
            const completedOrders = allOrders.filter(o => o.status === 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…').sort((a, b) => new Date(b.created_at || b.createdAt) - new Date(a.created_at || a.createdAt));

            if (hasPermission('sales')) {
            const totalRevenueSAR = allOrders.reduce((sum, order) => sum + (order.total_sar || order.totalSAR || 0), 0);
            const averageOrderValue = allOrders.length > 0 ? totalRevenueSAR / allOrders.length : 0;

            adminHtml += `
                <div class="bg-gray-900 p-6 rounded-xl shadow-lg border border-green-500 mb-8">
                    <h3 class="text-3xl font-bold text-green-400 mb-6">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-lg text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©)</p>
                            <p class="text-4xl font-bold text-white mt-2">${completedOrders.length}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-lg text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</p>
                            <p class="text-4xl font-bold text-white mt-2">${totalRevenueSAR.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-lg text-gray-400">Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨</p>
                            <p class="text-4xl font-bold text-white mt-2">${averageOrderValue.toFixed(2)} Ø±ÙŠØ§Ù„</p>
                        </div>
                    </div>
                </div>
            `;
            }

            // Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            adminHtml += `
                <div class="bg-gray-900 p-6 rounded-xl shadow-lg border border-cyan-500 mb-8">
                    <h3 class="text-3xl font-bold text-cyan-400 mb-6">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (${pendingOrders.length})</h3>
                    <div class="space-y-4">
                        ${pendingOrders.length > 0 ? pendingOrders.map(order => {
                            const customerName = order.customer_name || order.customerName || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                            const customerEmail = order.customer_email || order.customerEmail || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                            const customerPhone = order.customer_phone || order.customerPhone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                            const transactionId = order.transaction_id || order.transactionId || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                            const createdAt = order.created_at || order.createdAt;
                            return `
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="flex flex-col sm:flex-row justify-between items-start">
                                    <div class="flex-grow">
                                        <p class="text-xl font-bold text-white">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customerName}</p>
                                        <p class="text-sm text-gray-400">Ø§Ù„Ø¨Ø±ÙŠØ¯: ${customerEmail}</p>
                                        <p class="text-sm text-gray-400">Ø§Ù„Ù‡Ø§ØªÙ: ${customerPhone}</p>
                                        <p class="text-sm text-gray-300 font-mono bg-gray-900 px-2 py-1 rounded inline-block mt-2">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${order.id}</p>
                                        <p class="text-sm text-yellow-400 font-mono bg-gray-900 px-2 py-1 rounded inline-block mt-1">Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„: ${transactionId}</p>
                                        <p class="text-sm text-gray-400">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨: ${new Date(createdAt).toLocaleString('en-GB')}</p>
                                        <ul class="list-disc list-inside mt-2 text-gray-300">
                                            ${order.items.map(item => `<li>${item.name}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="text-left mt-4 sm:mt-0 sm:ml-4 flex-shrink-0">
                                        <p class="text-2xl font-bold text-cyan-400">${order.total}</p>
                                        <div class="flex gap-2 mt-2">
                                            <button onclick="deleteOrder('${order.id}')" class="bg-red-600 hover:bg-red-500 text-white font-bold p-2 rounded-lg transition" title="Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹">
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                            </button>
                                            <button onclick="completeOrder('${order.id}')" class="flex-grow bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}).join('') : '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>'} 
                    </div>
                </div>
            `;

            // Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ø§Ù„Ø£Ø±Ø´ÙŠÙ)
            adminHtml += `
                <div class="bg-gray-900 rounded-xl shadow-lg border border-gray-700 mb-8">
                    <details>
                        <summary class="p-6 cursor-pointer flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-gray-400">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ø§Ù„Ø£Ø±Ø´ÙŠÙ) (${completedOrders.length})</h3>
                            <svg class="w-6 h-6 text-gray-400 details-marker" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </summary>
                        <div class="p-6 border-t border-gray-700 space-y-4">
                             ${completedOrders.length > 0 ? completedOrders.map(order => {
                                const customerName = order.customer_name || order.customerName || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                                const customerEmail = order.customer_email || order.customerEmail || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                                const customerPhone = order.customer_phone || order.customerPhone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                                const createdAt = order.created_at || order.createdAt;
                                return `
                                <div class="bg-gray-800 p-4 rounded-lg opacity-70">
                                    <div class="flex flex-col sm:flex-row justify-between items-start">
                                        <div class="flex-grow">
                                            <p class="text-xl font-bold text-white">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customerName}</p>
                                            <p class="text-sm text-gray-500">Ø§Ù„Ø¨Ø±ÙŠØ¯: ${customerEmail}</p>
                                            <p class="text-sm text-gray-500">Ø§Ù„Ù‡Ø§ØªÙ: ${customerPhone}</p>
                                            <p class="text-sm text-gray-400 font-mono bg-gray-900 px-2 py-1 rounded inline-block mt-2">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${order.id}</p>
                                            <p class="text-sm text-gray-400">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…: ${new Date(createdAt).toLocaleString('en-GB')}</p>
                                        </div>
                                        <div class="text-left mt-4 sm:mt-0 sm:ml-4 flex-shrink-0">
                                            <p class="text-2xl font-bold text-gray-500">${order.total}</p>
                                            <div class="flex gap-2 mt-2">
                                                <button onclick="deleteOrder('${order.id}')" class="bg-red-800 hover:bg-red-700 text-white font-bold p-2 rounded-lg transition" title="Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ">
                                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `}).join('') : '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>'}
                        </div>
                    </details>
                </div>
            `;
            }
            // --- END OF NEW LOGIC ---

            if (hasPermission('products_view')) {
            for (const pageKey in allProducts) {
                if (!getPageTitle(pageKey) || ['orders', 'sale', 'discountCodes', 'maintenanceMode', 'featuredProducts'].includes(pageKey)) continue;
                const products = allProducts[pageKey] || [];
                const title = getPageTitle(pageKey);
                console.log('Ø¹Ø±Ø¶ Ù‚Ø³Ù…:', pageKey, 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', products.length);
                adminHtml += `
                    <div class="bg-gray-900 p-6 rounded-xl shadow-lg border border-gray-800 mb-8">
                        <h3 class="text-3xl font-bold text-cyan-400 mb-6">${title}</h3>
                        <div class="bg-gray-800 p-4 rounded-lg mb-6">
                            <h4 class="text-xl font-semibold text-white mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h4>
                            <form onsubmit="addProduct('${pageKey}', event)" class="grid grid-cols-1 md:grid-cols-4 gap-x-4 gap-y-6">
                                <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input name="name" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ© ÙØ§Ø¦Ù‚Ø©" required class="input-field w-full"></div>
                                <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„Ø³Ø¹Ø±</label><input name="price" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 500000" required class="input-field w-full"></div>
                                <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„Ø¹Ù…Ù„Ø©</label><select name="currency" required class="input-field w-full" style="color: #000000; background-color: #FFFFFF;">
                                    <option value="USD" selected>Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ ($)</option>
                                    <option value="SAR">Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ (Ø±ÙŠØ§Ù„)</option>
                                    <option value="AED">Ø§Ù„Ø¯Ø±Ù‡Ù… Ø§Ù„Ø¥Ù…Ø§Ø±Ø§ØªÙŠ (Ø¯.Ø¥)</option>
                                    <option value="KWD">Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„ÙƒÙˆÙŠØªÙŠ (Ø¯.Ùƒ)</option>
                                    <option value="BHD">Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†ÙŠ (Ø¯.Ø¨)</option>
                                    <option value="OMR">Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø¹Ù…Ø§Ù†ÙŠ (Ø±.Ø¹)</option>
                                    <option value="QAR">Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ù‚Ø·Ø±ÙŠ (Ø±.Ù‚)</option>
                                    <option value="IQD">Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ (Ø¯.Ø¹)</option>
                                    <option value="JOD">Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ (Ø¯.Ø£)</option>
                                </select></div>                                
                                <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input name="stock" type="number" placeholder="Ù…Ø«Ø§Ù„: 5" required class="input-field w-full"></div>
                                <div><label class="block text-sm font-medium text-gray-400 mb-1">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬</label><select name="status" required class="input-field w-full" style="color: #000000; background-color: #FFFFFF;" ${pageKey === 'investments' ? `onchange="toggleRentalFields(this, 'add-${pageKey}')"` : ''}>
                                    <option value="Ù…ØªÙˆÙØ±" selected>Ù…ØªÙˆÙØ±</option>
                                    <option value="Ù…Ø¨Ø§Ø¹">Ù…Ø¨Ø§Ø¹</option>
                                    ${pageKey === 'investments' ? '<option value="Ù…Ø¤Ø¬Ø±">Ù…Ø¤Ø¬Ø±</option>' : ''}
                                    <option value="ØºÙŠØ± Ù…ØªÙˆÙØ±">ØºÙŠØ± Ù…ØªÙˆÙØ±</option>
                                </select></div>
                                ${pageKey === 'investments' ? `<div id="rental-fields-add-${pageKey}" class="md:col-span-4 hidden">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-orange-900/20 p-4 rounded-lg border border-orange-500">
                                        <div><label class="block text-sm font-medium text-orange-400 mb-1">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„ØªØ£Ø¬ÙŠØ±</label><input name="rental_start_date" type="date" class="input-field w-full"></div>
                                        <div><label class="block text-sm font-medium text-orange-400 mb-1">Ù…Ø¯Ø© Ø§Ù„ØªØ£Ø¬ÙŠØ± (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label><input name="rental_duration_days" type="number" min="1" placeholder="Ù…Ø«Ø§Ù„: 30" class="input-field w-full"></div>
                                    </div>
                                </div>` : ''}
                                <div class="md:col-span-4">
                                    <label class="block text-sm font-medium text-gray-400 mb-1">ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</label>
                                    <textarea name="description" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ù†ØªØ¬..." class="input-field w-full h-24 resize-none"></textarea>
                                </div>
                                <div class="md:col-span-4">
                                    <label class="block text-sm font-medium text-gray-400 mb-1">ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬</label>
                                    <div class="image-urls-container">
                                        <div class="flex gap-2 mb-2">
                                            <input type="file" accept="image/*" onchange="uploadImage(this, '${pageKey}')" required class="input-field flex-1">
                                            <input name="imageUrl[]" type="hidden">
                                        </div>
                                    </div>
                                    <button type="button" onclick="addImageField(this)" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded mt-2">Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø£Ø®Ø±Ù‰</button>
                                </div>
                                <div class="md:col-span-4">
                                    <label class="block text-sm font-medium text-gray-400 mb-1">Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                    <input name="youtubeUrl" type="url" placeholder="https://www.youtube.com/watch?v=..." class="input-field w-full">
                                    <p class="text-xs text-gray-500 mt-1">Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±</p>
                                </div>
                                ${getExtraFields(pageKey)}
                                <div class="md:col-span-4">
                                    <button type="submit" class="w-full btn-primary py-2" ${!hasPermission('products_edit') ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
                                </div>
                            </form>
                        </div>
                        ${pageKey === 'investments' ? `
                        <div class="mb-4 flex gap-3">
                            <input type="text" id="filter-region-${pageKey}" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..." oninput="filterAdminProducts('${pageKey}')" class="input-field flex-1">
                            <input type="text" id="filter-square-${pageKey}" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø±Ø¨Ø¹..." oninput="filterAdminProducts('${pageKey}')" class="input-field flex-1">
                        </div>` : ''}
                        <div class="space-y-3" id="products-list-${pageKey}">
                            ${products.map((product, index) => {
                                const imgUrl = product.image_urls?.[0] || product.imageUrls?.[0] || product.image_url || product.imageUrl || '';
                                const extraInfo = pageKey === 'investments' ? `<p class="text-xs text-cyan-400">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${product.region || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} | Ø§Ù„Ù…Ø±Ø¨Ø¹: ${product.square || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>` : '';
                                const statusDropdown = pageKey === 'investments' && hasPermission('products_edit') ? `
                                    <select onchange="quickUpdateStatus('${pageKey}', ${product.id}, this.value)" class="text-xs px-2 py-1 rounded bg-gray-700 border border-gray-600 ${getStatusColor(product.status || 'Ù…ØªÙˆÙØ±')}" style="color: #000000; background-color: #FFFFFF;">
                                        <option value="Ù…ØªÙˆÙØ±" ${(product.status || 'Ù…ØªÙˆÙØ±') === 'Ù…ØªÙˆÙØ±' ? 'selected' : ''}>âœ… Ù…ØªÙˆÙØ±</option>
                                        <option value="Ù…Ø¨Ø§Ø¹" ${product.status === 'Ù…Ø¨Ø§Ø¹' ? 'selected' : ''}>ğŸ”´ Ù…Ø¨Ø§Ø¹</option>
                                        <option value="Ù…Ø¤Ø¬Ø±" ${product.status === 'Ù…Ø¤Ø¬Ø±' ? 'selected' : ''}>ğŸ’¼ Ù…Ø¤Ø¬Ø±</option>
                                        <option value="ØºÙŠØ± Ù…ØªÙˆÙØ±" ${product.status === 'ØºÙŠØ± Ù…ØªÙˆÙØ±' ? 'selected' : ''}>âš« ØºÙŠØ± Ù…ØªÙˆÙØ±</option>
                                    </select>
                                ` : `<p class="text-xs ${getStatusColor(product.status || 'Ù…ØªÙˆÙØ±')}">${getStatusIcon(product.status || 'Ù…ØªÙˆÙØ±')} ${product.status || 'Ù…ØªÙˆÙØ±'}</p>`;
                                return `
                                <div id="product-item-${pageKey}-${product.id}" class="flex items-center justify-between p-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition" data-region="${product.region || ''}" data-square="${product.square || ''}">
                                    <div class="flex items-center gap-4">
                                        <img src="${imgUrl}" alt="${product.name}" class="w-12 h-12 object-cover rounded-md cursor-pointer hover:opacity-75 transition" onerror="this.src='https://via.placeholder.com/48'" onclick="previewImage('${imgUrl}', '${product.name}')">
                                        <div>
                                            <h5 class="font-bold text-white">${product.name}</h5>
                                            <p class="text-sm text-gray-400">${formatAdminPrice(product.price, product.currency)} | Ø§Ù„ÙƒÙ…ÙŠØ©: ${product.stock} ${formatAdminRating(product)}</p>
                                            ${extraInfo}
                                            ${statusDropdown}
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        ${hasPermission('products_edit') ? `
                                        <button onclick="showEditForm('${pageKey}', ${product.id})" class="text-blue-400 hover:text-blue-300 p-2 rounded-full bg-gray-900 hover:bg-gray-700 transition" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                                        </button>
                                        <button onclick="deleteProduct('${pageKey}', ${product.id})" class="text-red-500 hover:text-red-400 p-2 rounded-full bg-gray-900 hover:bg-gray-700 transition" title="Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬">
                                           <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                        </button>` : ''}
                                    </div>
                                </div>
                            `}).join('') || '<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….</p>'}
                        </div>
                    </div>
                `;
            }

            }

            adminHtml += `</div>`;
            document.getElementById('admin-content').innerHTML = adminHtml;
            renderLogoutButton();
            
            // Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ø¥ÙŠØµØ§Ù„
            if (hasPermission('receipt')) {
                showReceiptVerification();
            }
            
            // Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            if (currentUser && currentUser.role === 'admin') {
                showUsersManagement();
            }
        }

        // Ø¯Ø§Ù„Ø© ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        function filterAdminProducts(pageKey) {
            const regionFilter = document.getElementById(`filter-region-${pageKey}`)?.value.toLowerCase() || '';
            const squareFilter = document.getElementById(`filter-square-${pageKey}`)?.value.toLowerCase() || '';
            const productsList = document.querySelectorAll(`#products-list-${pageKey} > div`);
            
            productsList.forEach(item => {
                const region = item.dataset.region?.toLowerCase() || '';
                const square = item.dataset.square?.toLowerCase() || '';
                const matchRegion = !regionFilter || region.includes(regionFilter);
                const matchSquare = !squareFilter || square.includes(squareFilter);
                
                if (matchRegion && matchSquare) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø³Ø±Ø¹Ø©
        async function quickUpdateStatus(pageKey, productId, newStatus) {
            if (!hasPermission('products_edit')) {
                showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', 'error');
                return;
            }
            
            if (newStatus === 'Ù…Ø¤Ø¬Ø±' && pageKey === 'investments') {
                showRentalModal(pageKey, productId);
                return;
            }
            
            try {
                const tableMap = {vehicles: 'vehicles', investments: 'investments', sponsors: 'sponsors', moneyServices: 'money_services', banJail: 'ban_jail'};
                const updateData = { status: newStatus };
                if (pageKey === 'investments') {
                    updateData.rental_start_date = null;
                    updateData.rental_duration_days = null;
                }
                await supabaseAdmin.updateProduct(tableMap[pageKey], productId, updateData);
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                await renderAdminPage();
            } catch (e) {
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
                console.error(e);
            }
        }
        
        function showRentalModal(pageKey, productId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-xl max-w-md w-full mx-4 border-2 border-orange-500">
                    <h3 class="text-2xl font-bold text-orange-400 mb-4">ğŸ’¼ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø§Ù„ØªØ£Ø¬ÙŠØ±</h3>
                    <form onsubmit="handleRentalSubmit(event, '${pageKey}', ${productId})" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-orange-400 mb-2">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„ØªØ£Ø¬ÙŠØ±</label>
                            <input type="date" name="rental_start_date" required class="input-field w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-orange-400 mb-2">Ù…Ø¯Ø© Ø§Ù„ØªØ£Ø¬ÙŠØ± (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label>
                            <input type="number" name="rental_duration_days" min="1" value="30" required class="input-field w-full">
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-2 rounded">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-500 text-white py-2 rounded">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ£Ø¬ÙŠØ±</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function handleRentalSubmit(event, pageKey, productId) {
            event.preventDefault();
            const form = event.target;
            const rentalStartDate = form.rental_start_date.value;
            const rentalDurationDays = parseInt(form.rental_duration_days.value);
            
            try {
                const tableMap = {vehicles: 'vehicles', investments: 'investments', sponsors: 'sponsors', moneyServices: 'money_services', banJail: 'ban_jail'};
                await supabaseAdmin.updateProduct(tableMap[pageKey], productId, {
                    status: 'Ù…Ø¤Ø¬Ø±',
                    rental_start_date: rentalStartDate,
                    rental_duration_days: rentalDurationDays
                });
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ£Ø¬ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                form.closest('.fixed').remove();
                await renderAdminPage();
            } catch (e) {
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ£Ø¬ÙŠØ±', 'error');
                console.error(e);
            }
        }

        function toggleDiscountTargetOptions(selectedValue) {
            const sectionContainer = document.getElementById('discount-target-section-container');
            const productContainer = document.getElementById('discount-target-product-container');

            sectionContainer.classList.add('hidden');
            productContainer.classList.add('hidden');

            if (selectedValue === 'section') {
                sectionContainer.classList.remove('hidden');
            } else if (selectedValue === 'product') {
                productContainer.classList.remove('hidden');
            }
        }

        // === Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ===
        let lastKnownOrderCount = 0;

        async function checkForNewOrders() {
            try {
                const allData = await getAllData();
                const newOrderCount = allData.orders ? allData.orders.length : 0;

                if (newOrderCount > lastKnownOrderCount) {
                    console.log('Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØµÙ„!');
                    showToast(`Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„: ${allData.orders[allData.orders.length - 1].customerName}`, 'success');
                    const sound = document.getElementById('notification-sound');
                    sound.play().catch(e => console.error("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", e));
                    await renderAdminPage(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                }
                
                lastKnownOrderCount = newOrderCount;
            } catch (error) {
                console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:", error);
            }
        }

        // Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        async function initializeAdminPanel() {
            try {
                await renderAdminPage();
                const products = await getAllData();
                lastKnownOrderCount = products.orders?.length || 0;
                setInterval(checkForNewOrders, 15000);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: ' + error.message, 'error');
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        window.onload = async () => {
            try {
                console.log('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...');
                
                if (!supabase) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Supabase');
                }
                
                console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Supabase Ø¨Ù†Ø¬Ø§Ø­');
                
                if (sessionStorage.getItem('isAdminAuthenticated') === 'true') {
                    console.log('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ØŒ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...');
                    currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                    await initializeAdminPanel();
                } else {
                    console.log('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ØŒ Ø¹Ø±Ø¶ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
                    renderLoginPage();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©:', error);
                document.body.innerHTML = `
                    <div class="min-h-screen flex flex-col items-center justify-center text-center p-4 bg-gray-900">
                        <div class="text-red-500 text-6xl mb-4">âŒ</div>
                        <h2 class="text-2xl font-bold text-white mb-2">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©</h2>
                        <p class="text-gray-400 mb-4">${error.message}</p>
                        <button onclick="location.reload()" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold py-2 px-4 rounded">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                    </div>
                `;
            }
        };

    </script>
</body>
</html>
